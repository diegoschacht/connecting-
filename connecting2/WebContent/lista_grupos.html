<html>
<head>
	<meta charset="UTF-8" />
	    <!-- add one of the jQWidgets styles -->
    <link rel="stylesheet" href="jqwidgets/styles/jqx.base.css" type="text/css" />
    <link rel="stylesheet" href="jqwidgets/styles/jqx.darkblue.css" type="text/css" />
    
    <!-- add the jQuery script -->
    <script type="text/javascript" src="scripts/jquery-3.2.0.js"></script>
    <!-- add the jQWidgets framework -->
    <script type="text/javascript" src="jqwidgets/jqx-all.js"></script>
    <!--  script type="text/javascript" src="jqwidgets/jqxcore.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxbuttons.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxdockpanel.js"></script>
    <script type="text/javascript" src="jqwidgets/jqxlistmenu.js"></script -->
</head>
<body>
	
	<table width="60%" align="center">
	<tr>
		<td>
			<b>Listado de Grupos</b><br><br>
		</td>
	</tr>
	<tr>
		<td>
			<div id="jqxToolBar"></div>
		</td>
	</tr>
	<tr>
		<td align="center">
			<div id="jqxgrid" align="center"></div>
		</td>
	</tr>
	</table>
	<script>
		$(document).ready(function () {	
			/*
			 * Inicializar el toolbar
			 */
			 $("#jqxToolBar").jqxToolBar({ width: "100%", height: 35, tools: "button | button | button",
	                minWidth:20,
				 	initTools: function (type, index, tool, menuToolIninitialization) {
	                    switch (index) {
		                    case 0:
	                            tool.text("Nuevo");
	                            tool.on("click",formularioCrear);
	                            break;    
		                    case 1:
	                            tool.text("Ver / Modificar");
	                            tool.on("click",formularioModificar);
	                            break;
	                        case 2:
	                        	tool.text("Eliminar");
	                        	tool.on("click",eliminar);
	                            break;
	                    }
	                }
	            });
			
			
			/*
			 * Inicializar la grilla
			 */
			 
			var source =
			{
			    datatype: "json",
			    datafields: [
			        { name: 'codGrupo' },
			        { name: 'nombre' },
			        { name: 'objetivo'},
			        { name: 'latitud'},
			        { name: 'longitud'},
			        { name: 'codUsuarioCreacion'},
			        { name: 'fechaUsuarioCreacion'},
			    ],
			    url:'rest/grupos'
			};
			var dataAdapter = new $.jqx.dataAdapter(source, {
			    loadComplete: function (data) { },
			    loadError: function (xhr, status, error) { }    
			});
			$("#jqxgrid").jqxGrid(
			{
			 	autoheight: true,
			 	autowidth: true,
			 	theme: 'energyblue',
				source: dataAdapter,
				pageable: true,
			    columns: [
			        { text: 'Codigo de grupo', datafield: 'codGrupo', width: 180 },
			        { text: 'Nombre', datafield: 'nombre', width: 180 },
			        { text: 'Objetivo', datafield: 'objetivo', width: 100 },
			        { text: 'Latitud', datafield: 'latitud', width: 180},
			        { text: 'Longitud', datafield: 'longitud', width: 100},
			        { text: 'Creado por el usuario', datafield: 'codUsuarioCreacion', width: 100},
			        { text: 'Fecha creacion', datafield: 'fechaUsuarioCreacion', width: 100},

			    ]
			});
		});
		
		$(document).ready(function () {
	        $("#formularioUsuario").jqxWindow({ width: 600, height: 300, autoOpen:false });
	    });
		
		//Configuraciones generales para invocaciones AJAX con JQuery
		$.ajaxSetup({
		    contentType : 'application/json',
		    processData : false
		});
		$.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
		    if (options.data){
		        options.data=JSON.stringify(options.data);
		    }
		});
	 	
		
		//Indica si el formulario se abre para editar usuario existente
		//o para crear uno nuevo
	 	var modo;
	 		 	
	 	
	 	/**
	 	 * Mostrar el formulario de edicion de usuarios
	 	 */
	 	function formularioModificar() {
	 		modo = 'edicion'; //se va a modificar usuario existente
	 		
	 		//cargar los datos de la fila seleccionada al formulario
	 		var selectedrowindex = $('#jqxgrid').jqxGrid('selectedrowindex'); 
	 		var grupo = $('#jqxgrid').jqxGrid('getrowdata', selectedrowindex);
	 		
	 		console.log('Id de fila:' + selectedrowindex);
	 		console.log(grupo);
	 		
	 		$('#codGrupo').val(grupo.codGrupo);
	 		$('#nombre').val(grupo.nombre);
	 		$('#objetivo').val(grupo.objetivo);
	 		$('#latitud').val(grupo.latitud);
	 		$('#longitud').val(grupo.longitud);
	 		$('#codUsuarioCreacion').val(grupo.codUsuarioCreacion);
	 		$('#fechaUsuarioCreacion').val(grupo.fechaUsuarioCreacion);

	 		$("#codGrupo").prop("readonly", true);
	 		
	 		//mostrar el formulario
	 		$('#formularioUsuario').jqxWindow('open');
	 	}
	 	
	 	/**
	 	 * Mostrar el formulario en modo creacion
	 	 */
	 	function formularioCrear() {
	 		modo = 'creacion'; //se va a crear nuevo usuario
	 			 		
	 		
	 		$('#codGrupo').val('');
	 		$('#nombre').val('');
	 		$('#objetivo').val('');
	 		$('#latitud').val('');
	 		$('#longitud').val('');
	 		$('#codUsuarioCreacion').val('');
	 		$('#fechaUsuarioCreacion').val('');
	 		
	 		$("#codGrupo").prop("readonly", false);
	 		
	 		//mostrar el formulario
	 		$('#formularioUsuario').jqxWindow('open');
	 	}
	 	
	 	
	 	/**
	 	 * Enviar los cambios al servidor
	 	 */
	 	function guardar() {
	 		
	 		console.log('Guardando en modo ' + modo);
	 		
	 		var grupo = {};
	 		
	 		grupo.codGrupo = $('#codGrupo').val();
	 		grupo.nombre = $('#nombre').val();
	 		grupo.objetivo = $('#objetivo').val();
	 		grupo.latitud = $('#latitud').val();
	 		grupo.longitud = $('#longitud').val();
	 		grupo.codUsuarioCreacion = $('#codUsuarioCreacion').val();
	 		grupo.fechaUsuarioCreacion = $('#fechaUsuarioCreacion').val();
	
	 		if (modo == 'edicion') {
	 			$.ajax({
	 			    type: "PUT",
	 			    url: "rest/grupos",
	 			    contentType: "application/json",
	 			    data: grupo,
	 			    success:function() {
	 					alert('Grupo guardado exitosamente');	
	 					$('#formularioUsuario').jqxWindow('close');
	 					location.reload(true);
	 				  }	
	 			});
	 		} else {  //creacion
	 		
	 			console.log("haciendo post de usuario ...")
	 			console.log(grupo);
	 			
	 			$.ajax({
	 			    type: "POST",
	 			    url: "rest/grupos",
	 			    contentType: "application/json",
	 			    data: grupo,
	 			    success:function() {
	 					alert('Grupo guardado exitosamente');	
	 					$('#formularioUsuario').jqxWindow('close');
	 					location.reload(true);
	 				  }	
	 			});
	 		}
	 	}
	 	
	 	function eliminar() {
	 		//cargar los datos de la fila seleccionada al formulario
	 		var selectedrowindex = $('#jqxgrid').jqxGrid('selectedrowindex'); 
	 		var grupo = $('#jqxgrid').jqxGrid('getrowdata', selectedrowindex);
	 		
	 		console.log('Id de fila:' + selectedrowindex);
	 		console.log('Grupo a borrar: ' + grupo.codGrupo);
		 		
	 		$.ajax({
 			    type: "DELETE",
 			    url: "rest/grupos/" + grupo.codGrupo,
 			    success:function() {
 					alert('grupo borrado exitosamente');	 					
 					location.reload(true);
 				  }	
 			});
	 	}
	 	
	</script>
	
	
	<!-- Formulario para creacion y edicion de usuarios -->
	<div id="formularioUsuario">
		<div>Formulario de Grupo</div>
		<div>
			<form>
				<table align="center">
					<tr>
						<td>Codigo de Grupo:</td><td><input id="codGrupo" type="number"/></td>
					</tr>
					<tr>
						<td>Nombre:</td><td> <input id="nombre" type="text"/></td>
					</tr>
					<tr>
						<td>Objetivo:</td><td><input id="objetivo" type="text"/></td>
					</tr>
					<tr>
						<td>Latitud:</td><td> <input id="latitud" type="text"/></td>
					</tr>
					<tr>
						<td>Longitud:</td><td> <input id="longitud" type="text"/></td>
					</tr>
					<tr>
						<td>Creado por el usuario:</td><td> <input id="codUsuarioCreacion" type="text"/></td>
					</tr>
					<tr>
						<td>Fecha creacion:</td><td> <input id="fechaUsuarioCreacion" type="text"/></td>
					</tr>
					<tr>
						<td><input type="button" value="Guardar" onclick="guardar();" /></td>
						<td><input type="button" value="Cancelar" onclick="$('#formularioUsuario').jqxWindow('close');"  /></td>
					</tr>
				</table>
			</form>			
		</div>
	</div>
</body>
</html>